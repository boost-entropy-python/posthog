{% extends "email/base.html" %}
{% load posthog_assets %}
{% load posthog_filters %}

{% block head %}
<style type="text/css">
    body, .main { background-color: #f3f4f0 !important; }
</style>
{% endblock %}

{% block preheader %}Error tracking weekly digest for {{ organization.name }} organization{% endblock %}

{% block main %}
<p style="font-size: 1.1em; color: #374151; margin: 0 0 24px 0;">Error tracking weekly digest for <strong>{{ organization.name }}</strong> organization</p>

{% for section in project_sections %}
<!-- Project section: {{ section.team.name }} -->
<div style="margin-bottom: 40px;">
    <table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin-bottom: 12px;">
        <tr>
            <td style="width: 50%; vertical-align: middle;"><div style="height: 1px; background-color: #d1d5db;"></div></td>
            <td style="white-space: nowrap; padding: 0 16px; vertical-align: middle;">
                <a href="{{ section.error_tracking_url }}" target="_blank" style="font-size: 1.15em; font-weight: 600; color: #111827; text-decoration: none;">{{ section.team.name }}</a>
            </td>
            <td style="width: 50%; vertical-align: middle;"><div style="height: 1px; background-color: #d1d5db;"></div></td>
        </tr>
    </table>

    <!-- Total -->
    <div style="background-color: #ffffff; border-radius: 8px; padding: 20px; margin-bottom: 8px;">
        <div style="text-align: center;">
            <div style="font-size: 0.8em; color: #6b7280; margin-bottom: 4px;">Total exceptions</div>
            <p style="margin: 0; font-size: 2.5em; font-weight: bold; line-height: 1.1;">
                {{ section.exception_count|compact_number }}
            </p>
            {% if section.exception_change %}
            <p style="margin: 0 0 12px 0; font-size: 0.85em; color: {{ section.exception_change.color }};">{{ section.exception_change.long_text }}</p>
            {% else %}
            <div style="margin-bottom: 12px;"></div>
            {% endif %}
            {% if section.daily_counts %}
            <table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin: 0 auto;">
                <tr>
                    {% for day in section.daily_counts %}
                    <td align="center" valign="bottom" style="padding: 0 3px; height: 60px;">
                        <div style="width: 100%; min-width: 20px; height: {{ day.height_percent }}%; {% if day.height_percent > 0 %}min-height: 3px;{% endif %} background-color: #9f9fa9; border-radius: 3px 3px 0 0;"></div>
                    </td>
                    {% endfor %}
                </tr>
                <tr><td colspan="{{ section.daily_counts|length }}" style="height: 1px; background-color: #e1e5e9; padding: 0; font-size: 0; line-height: 0;"></td></tr>
                <tr>
                    {% for day in section.daily_counts %}
                    <td align="center" style="padding: 4px 3px 0; font-size: 0.75em; color: #9ca3af;">{{ day.day }}</td>
                    {% endfor %}
                </tr>
            </table>
            {% endif %}
        </div>
        {% if section.crash_free %}
        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin-top: 16px; border-top: 1px solid #f3f4f6; padding-top: 16px;">
            <tr>
                <td align="center" style="text-align: center; padding: 8px;">
                    <div style="font-size: 0.8em; color: #6b7280;">Total sessions</div>
                    <div style="font-size: 1.5em; font-weight: bold;">{{ section.crash_free.total_sessions|compact_number }}</div>
                    {% if section.crash_free.total_sessions_change %}
                    <div style="font-size: 0.75em; color: {{ section.crash_free.total_sessions_change.color }};">{{ section.crash_free.total_sessions_change.text }}</div>
                    {% endif %}
                </td>
                <td align="center" style="text-align: center; padding: 8px;">
                    <div style="font-size: 0.8em; color: #6b7280;">Crash free sessions</div>
                    <div style="font-size: 1.5em; font-weight: bold;">{{ section.crash_free.crash_free_rate }}%</div>
                    {% if section.crash_free.crash_free_rate_change %}
                    <div style="font-size: 0.75em; color: {{ section.crash_free.crash_free_rate_change.color }};">{{ section.crash_free.crash_free_rate_change.text }}</div>
                    {% endif %}
                </td>
            </tr>
        </table>
        {% endif %}
    </div>

    <!-- Top issues -->
    {% if section.top_issues %}
    <div style="background-color: #ffffff; border-radius: 8px; padding: 20px; margin-bottom: 8px;">
        <h3 style="margin: 0 0 4px 0; text-align: left;">Top issues</h3>
        <p style="margin: 0 0 12px 0; font-size: 0.85em; color: #6b7280; text-align: left;">Issues sorted by occurrence count this week</p>
        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid #e1e5e9;">
                    <th align="left" style="padding: 8px 8px 8px 0; font-size: 0.75em; color: #9ca3af; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; text-align: left;">Issue</th>
                    <th align="center" style="padding: 8px; font-size: 0.75em; color: #9ca3af; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; width: 90px;">Volume</th>
                    <th align="right" style="padding: 8px 0 8px 8px; font-size: 0.75em; color: #9ca3af; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; width: 90px;">Occurrences</th>
                </tr>
            </thead>
            <tbody>
                {% for issue in section.top_issues %}
                <tr style="border-bottom: 1px solid #f3f4f6;">
                    <td align="left" style="padding: 10px 8px 10px 0; vertical-align: top; text-align: left;">
                        <a href="{{ issue.url }}" target="_blank" style="text-decoration: none; color: #111827; font-weight: 600; font-size: 0.9em;">{{ issue.name|truncatechars:40 }}</a>
                        {% if issue.description %}
                        <div style="color: #6b7280; font-size: 0.8em; margin-top: 2px;">{{ issue.description|truncatechars:45 }}</div>
                        {% endif %}
                    </td>
                    <td align="center" style="padding: 10px 8px; vertical-align: middle; width: 90px;">
                        {% if issue.sparkline %}
                        <table cellpadding="0" cellspacing="0" border="0" style="margin: 0 auto; height: 24px;">
                            <tr>
                                {% for bar in issue.sparkline %}
                                <td valign="bottom" style="padding: 0 1px; height: 24px;">
                                    <div style="width: 8px; height: {{ bar.height_percent }}%; {% if bar.height_percent > 0 %}min-height: 2px;{% endif %} background-color: #9f9fa9; border-radius: 1px;"></div>
                                </td>
                                {% endfor %}
                            </tr>
                            <tr><td colspan="{{ issue.sparkline|length }}" style="height: 1px; background-color: #e1e5e9; padding: 0; font-size: 0; line-height: 0;"></td></tr>
                        </table>
                        {% endif %}
                    </td>
                    <td align="right" style="padding: 10px 0 10px 8px; vertical-align: middle; color: #111827; white-space: nowrap; width: 90px;">
                        {{ issue.occurrence_count|compact_number }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- New issues -->
    {% if section.new_issues %}
    <div style="background-color: #ffffff; border-radius: 8px; padding: 20px; margin-bottom: 8px;">
        <h3 style="margin: 0 0 4px 0; text-align: left;">New issues</h3>
        <p style="margin: 0 0 12px 0; font-size: 0.85em; color: #6b7280; text-align: left;">Issues first seen this week sorted by occurrence count</p>
        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid #e1e5e9;">
                    <th align="left" style="padding: 8px 8px 8px 0; font-size: 0.75em; color: #9ca3af; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; text-align: left;">Issue</th>
                    <th align="center" style="padding: 8px; font-size: 0.75em; color: #9ca3af; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; width: 90px;">Volume</th>
                    <th align="right" style="padding: 8px 0 8px 8px; font-size: 0.75em; color: #9ca3af; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; width: 90px;">Occurrences</th>
                </tr>
            </thead>
            <tbody>
                {% for issue in section.new_issues %}
                <tr style="border-bottom: 1px solid #f3f4f6;">
                    <td align="left" style="padding: 10px 8px 10px 0; vertical-align: top; text-align: left;">
                        <a href="{{ issue.url }}" target="_blank" style="text-decoration: none; color: #111827; font-weight: 600; font-size: 0.9em;">{{ issue.name|truncatechars:40 }}</a>
                        {% if issue.description %}
                        <div style="color: #6b7280; font-size: 0.8em; margin-top: 2px;">{{ issue.description|truncatechars:45 }}</div>
                        {% endif %}
                    </td>
                    <td align="center" style="padding: 10px 8px; vertical-align: middle; width: 90px;">
                        {% if issue.sparkline %}
                        <table cellpadding="0" cellspacing="0" border="0" style="margin: 0 auto; height: 24px;">
                            <tr>
                                {% for bar in issue.sparkline %}
                                <td valign="bottom" style="padding: 0 1px; height: 24px;">
                                    <div style="width: 8px; height: {{ bar.height_percent }}%; {% if bar.height_percent > 0 %}min-height: 2px;{% endif %} background-color: #9f9fa9; border-radius: 1px;"></div>
                                </td>
                                {% endfor %}
                            </tr>
                            <tr><td colspan="{{ issue.sparkline|length }}" style="height: 1px; background-color: #e1e5e9; padding: 0; font-size: 0; line-height: 0;"></td></tr>
                        </table>
                        {% endif %}
                    </td>
                    <td align="right" style="padding: 10px 0 10px 8px; vertical-align: middle; color: #111827; white-space: nowrap; width: 90px;">
                        {{ issue.occurrence_count|compact_number }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Ingestion failures -->
    {% if section.ingestion_failure_count > 0 %}
    <div style="background-color: #fef3cd; border: 1px solid #ffc107; padding: 20px; border-radius: 8px; margin-bottom: 8px;">
        <p style="margin: 0 0 8px 0; font-weight: 700; color: #856404; font-size: 1em;">
            &#9888; {{ section.ingestion_failure_count|compact_number }} exceptions failed to ingest
        </p>
        <p style="margin: 0 0 16px 0; color: #664d03; font-size: 0.9em;">
            This is usually caused by malformed events being sent. You can inspect each failed exception to see what went wrong by expanding it.
        </p>
        <table cellpadding="0" cellspacing="0" border="0" width="100%">
            <tr>
                <td align="right" style="text-align: right;">
                    <a href="{{ section.ingestion_failures_url }}" target="_blank" style="display: inline-block; padding: 8px 16px; background-color: #856404; color: #ffffff; text-decoration: none; border-radius: 6px; font-size: 0.9em; font-weight: 500; margin-right: 8px;">View these exceptions</a>
                    <a href="{{ contact_support_url }}" target="_blank" style="display: inline-block; padding: 8px 16px; background-color: transparent; color: #856404; text-decoration: none; border: 1px solid #856404; border-radius: 6px; font-size: 0.9em; font-weight: 500;">Contact support</a>
                </td>
            </tr>
        </table>
    </div>
    {% endif %}

</div>
{% endfor %}

{% if disabled_project_names or excluded_project_count > 0 %}
<table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin-bottom: 12px;">
    <tr>
        <td style="width: 50%; vertical-align: middle;"><div style="height: 1px; background-color: #d1d5db;"></div></td>
        <td style="white-space: nowrap; padding: 0 16px; vertical-align: middle;">
            <span style="font-size: 0.9em; font-weight: 600; color: #6b7280;">Note</span>
        </td>
        <td style="width: 50%; vertical-align: middle;"><div style="height: 1px; background-color: #d1d5db;"></div></td>
    </tr>
</table>
<div style="background-color: #ffffff; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
    {% if disabled_project_names %}
    <p style="margin: 0 0 8px 0; font-size: 0.9em; color: #6b7280;">This report did not include the following projects because they are disabled in your settings:</p>
    <ul style="margin: 0 0 {% if excluded_project_count > 0 %}16px{% else %}0{% endif %} 0; padding-left: 20px; color: #6b7280; font-size: 0.9em;">
        {% for name in disabled_project_names %}
        <li>{{ name }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% if excluded_project_count > 0 %}
    <p style="margin: 0; font-size: 0.9em; color: #6b7280;">{{ excluded_project_count }} other project{{ excluded_project_count|pluralize }} in your organization had no exceptions this week and {{ excluded_project_count|pluralize:"was,were" }} not included in this digest.</p>
    {% endif %}
</div>
{% if disabled_project_names %}
<div style="margin-bottom: 16px; text-align: center;">
    <a href="{{ settings_url }}" style="color: #6b7280; font-size: 0.85em; text-decoration: underline;">Change notification settings</a>
</div>
{% endif %}
{% endif %}

<div style="margin-bottom: 16px; text-align: center;">
    <a href="{{ feedback_survey_url }}" target="_blank" style="color: #6b7280; font-size: 0.85em; text-decoration: underline;">Share feedback on this digest</a>
</div>
{% endblock %}

{% block footer %}{% endblock %}
